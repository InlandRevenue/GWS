<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emulated Auth & Gateway Service</title>
    <link rel="stylesheet" href="index/base.css"/>
</head>
<body>
<div class="container"><h1 id="welcome-to-employment-emulated-service">Welcome to Employment Emulated Service</h1>
    <a href="index/version.html">version</a>: ${version}

    <h2 id="key-features">Key Features:</h2>

    <ul>
        <li>Simulating Authentication Flow <br>
            <ul>
                <li>Issuing Auth Access Token</li>
                <li>Validating Auth Access Token</li>
            </ul>
        </li>
        <li>Simulating Employment Operations <br>
            <ul>
                <li>Positive Response</li>
                <li>Schema Validation</li>
                <li>Error Handling (Not Included)</li>
            </ul>
        </li>
    </ul>


    <h2 id="features-details">Features Details:</h2>

    <ul>
        <li><p>Simulating Authentication Flow: <br><br>
            High Level Flow <br>
            <img src="index/high_level_flow.jpg"> <br><br>
            Sequence Diagram <br>
            <img src="index/sequence_diagram.png" width="80%" height="80%"></p>

            <ul>
                <li><p>Flow A - full authentication flow: this is an emulated Auth service, so as a service provider you
                    would need to trigger customer's behaviour to complete this Auth flow.</p>

                    <ol>
                        <li>Customer accesses the Client Application via browser. They take an action that requires
                            access to IR Gateway Services.
                        </li>
                        <li><p>The Client Application invokes the Auth Server to get access token, the customer's
                            browser is redirected to IR login page. <br>
                            At this step as a service provider you need to send a HTTP GET request to Auth Server, url
                            format as below:</p>

                            <blockquote>
                                <p>
                                    https://oauth-es.ird.digitalpartner.services/ms_oauth/oauth2/endpoints/oauthservice/authorize?client_id={ClientID}&amp;redirect_uri={RedirectURI}&amp;scope={Scope}&amp;response_type=code</p>
                            </blockquote>

                            <ul>
                                <li>Parameters: <br>
                                    <ul>
                                        <li>{ClientID}: a valid Client identifier, <strong>see Valid Clients table below</strong></li>
                                        <li>{RedirectURI}: Client Application's redirect URI</li>
                                        <li>{Scope}: e.g. MYIR.Services</li>
                                    </ul>
                                </li>
                                <br>
                                <table border="1">
                                    <caption><b>Valid Clients</b></caption>
                                    <tr>
                                        <th>Client Id</th>
                                        <th>Client Secret</th>
                                        <th>Has users</th>
                                    </tr>
                                    <tr>
                                        <td>TestClient1</td>
                                        <td>TestClient1Secret</td>
                                        <td>yes</td>
                                    </tr>
                                    <tr>
                                        <td>TestClient2</td>
                                        <td>TestClient2Secret</td>
                                        <td>no</td>
                                    </tr>
                                </table>
                            </ul>
                        </li>
                        <li><p>Customer login to MyIR and consent - Customer submits credentials, consent page and
                            redirection pages are skipped in this emulated service. <br>
                            At this step as a service provider you need to send a HTTP POST request to Auth Server. <br>
                            Url format: </p>

                            <blockquote>
                                <p>https://oauth-es.ird.digitalpartner.services/oam/server/auth_cred_submit</p>
                            </blockquote>

                            <p>Request headers MUST include:</p>

                            <blockquote>
                                <p>Content-Type: application/x-www-form-urlencoded <br>
                                    Cookie: {CookieFromLastStep}</p>
                            </blockquote>

                            <p>Request body: </p>

                            <blockquote>
                                <p>userid={CustomerUserID}&amp;password={CustomerUserPassword}&amp;login=Login</p>
                            </blockquote>

                            <ul>
                                <li>Parameters: <br>
                                    <ul>
                                        <li>{CustomerUserID}: <strong>can be anything for clients that have users (see Valid Clients table above).</strong></li>
                                        <li>{CustomerUserPassword}: <strong>can be anything for clients that have users (see Valid Clients table above).</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><p>Authorization Code returns to Client Application by a HTTP 302 redirection to the
                            redirectURI. <br>
                            Response url format:</p>

                            <blockquote>
                                <p>https://{RedirectURI}?code={AuthorizationCode}</p>
                            </blockquote>

                            <ul>
                                <li>Parameters: <br>
                                    - {RedirectURI}: Client Application's redirect URI <br>
                                    - {AuthorizationCode}: the Authorization Code to be used for retrieving an access
                                    token
                                </li>
                            </ul>
                        </li>
                        <li><p>Client Application retrieves Auth Access Token by sending Authorization Code as well as
                            Client Application's credentials <br>
                            Url format:</p>

                            <blockquote>
                                <p>
                                    https://oauth-es.ird.digitalpartner.services/ms_oauth/oauth2/endpoints/oauthservice/tokens</p>
                            </blockquote>

                            <p>Request headers MUST include:</p>

                            <blockquote>
                                <p>Authorization: Basic {ClientApplicationEncodedCredentials}</p>
                                <p>Content-Type: application/x-www-form-urlencoded</p>
                            </blockquote>

                            <ul>
                                <li>Parameters: <br>
                                    <ul>
                                        <li>{ClientApplicationEncodedCredentials}: the encoded Client Application's
                                            credentials, must be Base64 encoded. <strong>ClientID MUST match the ClientID
                                                used in step 2 and ClientSecret must be the correct one for the ClientID (see Valid
                                                Clients table above)</strong></li>
                                    </ul>
                                </li>
                            </ul>

                            <p>Request body:</p>

                            <blockquote>
                                <p>redirect_uri={RedirectURI}&amp;grant_type=authorization_code&amp;code={AuthorizationCode}</p>
                            </blockquote>

                            <ul>
                                <li>Parameters: <br>
                                    <ul>
                                        <li>{RedirectURI}: Client Application's redirect URI. <strong>URI must be
                                            URL-encoded.</strong></li>
                                        <li>{AuthorizationCode}: the Authorization Code retrieved from last step</li>
                                    </ul>
                                </li>
                            </ul>

                            <p>Response body format as below, {AuthAccessToken} is the token string:</p>

                            <blockquote>
                                <p>{"expires_in":28800,"token_type":"Bearer","access_token":"{AuthAccessToken}"}</p>
                            </blockquote>
                        </li>
                        <li><p>Client Application invokes IR Gateway Services with the Auth Access Token in header <br>
                            Url format:</p>

                            <blockquote>
                                <p>https://mock-es.ird.digitalpartner.services/gateway/GWS/Employment</p>
                            </blockquote>

                            <p>Request headers MUST include:</p>

                            <blockquote>
                                <p>Authorization: Bearer {AuthAccessToken}</p>
                            </blockquote>

                            <p>Request body is the actual service payload (please refer the request samples in this
                                page)</p></li>
                    </ol>
                </li>
            </ul>
        </li>
        <li><p>Simulating Employment Operations:</p>

            <ul>
                <li>Create <br>
                    <ul>
                        <li>Positive response<br>
                            <ul>
                                <li><a href="employment/body-employment-create-request.xml">request sample</a></li>
                                <li><a href="employment/body-employment-create-response.xml">response sample</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>Terminate <br>
                    <ul>
                        <li>Positive response<br>
                            <ul>
                                <li><a href="employment/body-employment-terminate-request.xml">request sample</a></li>
                                <li><a href="employment/body-employment-terminate-response.xml">response sample</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>Update <br>
                    <ul>
                        <li>Positive response<br>
                            <ul>
                                <li><a href="employment/body-employment-update-request.xml">request sample</a></li>
                                <li><a href="employment/body-employment-update-response.xml">response sample</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>RetrieveList <br>
                    <ul>
                        <li>Positive response<br>
                            <ul>
                                <li><a href="employment/body-employment-retrievelist-request.xml">request sample</a></li>
                                <li><a href="employment/body-employment-retrievelist-response.xml">response sample</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>

    <h2 id="requests-matching-logic">Requests Matching Logic</h2>

    <ul>
        <li>ReadMe Page - (default) port 443 of root path of Welcome Page, you are already here</li>
        <li>Authentication mappings - (default) port 443 of following paths: <br>
            <ul>
                <li>/ms_oauth/oauth2/endpoints/oauthservice/authorize</li>
                <li>/oam/server/auth_cred_submit</li>
                <li>/ms_oauth/oauth2/endpoints/oauthservice/tokens</li>
            </ul>
        </li>
        <li>Service Mappings - (default) port 443 of path "/gateway/GWS/Employment": <br>
            <ul>
                <li>/gateway/GWS/Employment?wsdl - wsdl is not available, returning http 200 only</li>
                <li>/gateway/GWS/Employment - Authentication validation will be performed at first: <br>
                    <ul>
                        <li>if fail then return Authentication Errors</li>
                        <li>if pass then: <br>
                            <ul>
                                <li>XML validation will be performed: <br>
                                    <ul>
                                        <li>if fail then return XML Validation Errors</li>
                                        <li>if pass then return positive responses</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>Default Mapping - Very last matching logic to handle all other requests by returning 404 error when no
            matching found
        </li>
    </ul>

    <h2 id="curl-commands">Sample curl commands</h2>
    <ul>
        <li> Once  Whitelisted , follow below steps to confirm Onboarding
        <li><b> Test the OAuth Flow </b></li>
        <ul>
            <b> Request Auth Code </b>
            <blockquote>
                <pre>curl -v 'https://oauth-es.ird.digitalpartner.services/ms_oauth/oauth2/endpoints/oauthservice/authorize?client_id=TestClient1&redirect_uri=https://testpartner.ird.services/&scope=MYIR.Services&response_type=code' -c cookie.txt -D cookie_header.txt</pre>
            </blockquote>
            <li>The above command writes out the session cookie to cookie.txt and its header to cookie_header.txt. Both of these files are used in the next command</li>

            <b> Get Auth Code </b>
            <blockquote>
                <pre>curl -v -X POST https://oauth-es.ird.digitalpartner.services/oam/server/auth_cred_submit -H 'content-type: application/x-www-form-urlencoded' -d 'userid=userid&password=password&login=Login' -b cookie.txt -c cookie.txt -D cookie_header.txt</pre>
            </blockquote>
            <li>The above command outputs the authorization_code as 'code=' onto the stdout/terminal in two places (1 or 2 like below) which needs to be used in the next command.</li>

            <b> Get Auth Token </b>
            <blockquote>
                <pre>curl -v -X POST 'https://oauth-es.ird.digitalpartner.services/ms_oauth/oauth2/endpoints/oauthservice/tokens' -H 'content-type: application/x-www-form-urlencoded' -H 'Authorization: Basic VGVzdENsaWVudDE6VGVzdENsaWVudDFTZWNyZXQ=' -d 'redirect_uri=https%3A%2F%2Ftestpartner.ird.services%2F&grant_type=authorization_code&code={CODE_FROM_ABOVE_COMMAND}' -o token.txt</pre>
            </blockquote>
            <li>The above command writes out the authentication token to token.txt. The token is used in GWS requests like the one below. The authorization header in the above command is the ClientId and ClientSecret base64 encoded.</li>

            <b> API call to send ES Create Request </b>
            <blockquote>
                <pre>curl -X POST 'https://mock-es.ird.digitalpartner.services/gateway/GWS/Employment' -H 'Authorization: Bearer {TOKEN_FROM_ABOVE_COMMAND}' -H 'Content-Type: application/x-www-form-urlencoded' -d @body-employment-create-request.xml</pre>
            </blockquote>
            <li>Authorization token is from the token.txt file in the previous step and body-employment-create-request.xml is from sample payload</li>
        </ul>
        </li>
    </ul>

    <h2 id="test-scenarios">Test Scenarios</h2>
    <a href="index/Emulated_Services_Coverage_Map-ES.png"><img src="index/Emulated_Services_Coverage_Map-ES.png"></a>

    <h2 id="test-data">Test Data</h2>

    <p>This table shows which scenarios (as per their numbers in the mindmap) require specific data to trigger the expected responses.
        Text in italics represents the name of the XML node in the request.</p>
    <table>
        <tr>
            <th>Operation</th>
            <th>Scenario ID</th>
            <th>Data</th>
        </tr>
        <tr>
            <td>RetrieveList</td>
            <td>EMS_ES081</td>
            <td>
                Employee IRD number (<em>employeeIRD</em>): 123114116
            </td>
        </tr>
        <tr>
            <td>Update</td>
            <td>EMS_ES096</td>
            <td>
                Employer IRD number (<em>identifier</em>): 123183711
            </td>
        </tr>
        <tr>
            <td>Create</td>
            <td>EMS_ES095</td>
            <td>
                Employer IRD number (<em>identifier</em>): 123183711
            </td>
        </tr>
        <tr>
            <td>Update</td>
            <td>EMS_ES099</td>
            <td>
                <em>employmentStartDate</em> : today's date
            </td>
        </tr>
    </table>

</div>
</body>
</html>